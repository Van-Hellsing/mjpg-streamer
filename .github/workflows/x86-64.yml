name: amd64

on:
  push:
    branches: [ master ]
#  pull_request:
#    branches: [ debianize ]

defaults:
  run:
    working-directory: ./mjpg-streamer-experimental
    
jobs:
  build:
    runs-on: ubuntu-18.04
    container:
      image: debian:buster

    steps:
    - uses: actions/checkout@v2
    - name: install_1
      run: |
       apt update
       apt-get install -y libsdl1.2-dev libjpeg62-turbo-dev
      # libjpeg8-dev gcc g++
    - name: install_2
      run: apt-get install -y debhelper devscripts cmake libgphoto2-dev libopencv-dev python3-numpy python3-dev libzmq3-dev libprotobuf-c-dev protobuf-c-compiler
 #   - name: install_3
 #     run: sudo apt-get install dpkg debconf lintian
    - name: make
      run: |
       sed -i 's/\${OpenCV_VERSION_MAJOR} EQUAL 3)/"\${OpenCV_VERSION_MAJOR} EQUAL 3")/' plugins/input_opencv/CMakeLists.txt
       sed -i 's/\${PYTHON_VERSION_MAJOR} EQUAL 3)/"\${PYTHON_VERSION_MAJOR} EQUAL 3")/' plugins/input_opencv/filters/cvfilter_py/CMakeLists.txt
       tar -zcf ../mjpg-streamer-experimental.orig.tar.gz ../mjpg-streamer-experimental
       dpkg-buildpackage -r -us -uc
    - name: makemake
      run: |
        fakeroot
        make install DESTDIR=`pwd`/tempinstall
#    - name: check
#      run: lintian -v ../*.deb
    - name: Creating out
      id: ver
      run: |
       ls -l debian/mjpg-streamer/usr/lib/mjpg-streamer
       rm -r ../mjpg-streamer-experimental ../.g* ../README.md
       echo ::set-output name=uname::$(uname -m)
       echo "The uname output was ${{ steps.ver.outputs.uname }}"
    - name: Upload build 
      uses: actions/upload-artifact@v2
      with: 
         name: "mjpg-streamer-${{ steps.ver.outputs.uname }}"
         path: .
